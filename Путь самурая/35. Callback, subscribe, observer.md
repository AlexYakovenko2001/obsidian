[[Samurai way]]
### Callback, subscribe, observer
**Theory:**
Сейчас возникла такая ситуация: из файла **render.tsx** импортируется в файл **state.ts** функция *rerenderEntireTree*, а из файла **state.ts** в **render.tsx** импортируется стейт и функции, которые прокидываются в компоненту *Арр*. То есть снова циклическая зависимость, от неё нужно избавляться.
**Actions:**
1. Удаляем всю логику из файла **render.tsx** и переносим в **index.tsx**. ![[Pasted image 20221004084106.png]]
2. Удаляем файл **render.tsx**.
3. Удаляем экспорт из функции *rerenderEntireTree*, т.к. эта функция нужна в файле **state.ts**, но если сейчас разрешить стейту импортировать её из индекса, а в индекс импортировать стейт, то снова получится циклическая зависимость.
4. Для того, чтобы решить эту проблему, необходимо создать внутри **state.ts** какую-нибудь функцию, которую можно будет импортировать в **index.tsx**, а уже внутрь её закинуть нашу функцию *rerenderEntireTree* (вроде здесь концепция коллбеков, но в этом случае я не врубаюсь как оно работает и почему при таком раскладе это не считается циклической зависимостью)
5. Для начала создадим внутри файла **state.ts** функцию, которая будет отвечать за перерисовку. Дадим ей такое же название, как и той, которая содержит в себе код, заставляющий приложение перерисовываться(т.к. у нас в коде уже используется такое название, поэтому создаём с таким же названием, чтобы потом не менять его в коде) .![[Pasted image 20221004161232.png]]
6. Определим её с помощью *let* и оставим пустой, т.к. дальше ей будет присвоено другое значение.                               ![[Pasted image 20221004160724.png]]
7. Далее в файле **state.ts** создаём функцию, внутрь которой будет помещён коллбек, позволяющий импортировать код, отвечающий за перерисовку. Назовём её **subscribe** и её аргумент можно назвать **observer**, в качестве аргумента будет передаваться функция, поэтому нужно его соответствующим образом типизировать. Внутри функции присваиваем значение *observer* функции *rerenderEntireTree*. Звучит сложно, поэтому будет фото того, как оно должно выглядеть.                                                                                                                          ![[Pasted image 20221004161549.png]]
8. Вызываем функцию *subscribe* в файле **index.tsx** и указываем ей в качестве аргумента функцию *rerenderEntireTree*. ![[Pasted image 20221004161858.png]]
9. 14 строчку кода подчеркнул жёлтым. Это очень важная штука, забыл прописать эту строку и сидел больше часа над кодом, не мог понять почему ошибок нет, а ничего не отрисовывается. Пошёл на суппорт и только там ментор мне объяснил, что функцию *rerenderEntireTree* обязательно нужно вызвать внутри **index.tsx** хотя бы раз, т.к. она же отвечает и за первую отрисовку приложения, и за последующие. А т.к. я её только определил, но не вызвал внутри **index.tsx**, то и первой отрисовки не было, поэтому и видел пустой экран.